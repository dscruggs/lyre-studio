steps:
  # Pull previous image for cache (ignore failure if first build)
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'docker pull gcr.io/$PROJECT_ID/lyre-backend:latest || exit 0']
  
  # Build with cache from previous image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/lyre-backend:latest'
      - '-t'
      - 'gcr.io/$PROJECT_ID/lyre-backend:$BUILD_ID'
      - '-f'
      - 'Dockerfile.backend'
      - '--cache-from'
      - 'gcr.io/$PROJECT_ID/lyre-backend:latest'
      - '--build-arg'
      - 'HF_TOKEN=$_HF_TOKEN'
      - '.'

images:
  - 'gcr.io/$PROJECT_ID/lyre-backend:latest'
  - 'gcr.io/$PROJECT_ID/lyre-backend:$BUILD_ID'

substitutions:
  _HF_TOKEN: ''

timeout: '3600s'
